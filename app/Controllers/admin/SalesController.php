<?php
namespace App\Controllers\admin;

use CodeIgniter\Controller;
use App\Models\ProductModel;
use App\Models\Salesmodel;
use App\Models\SaleItemModel;
use App\Models\PurchaseOrderItemModel;
use App\Models\CustomerOrderModel;
use App\Models\CustomerOrderItemsModel;
use App\Models\UsersregistrationsModel;
use Mpdf\Mpdf;

class SalesController extends Controller {
    protected $productModel;
    protected $salesModel;
    protected $saleItemModel;
    protected $purchaseItemModel;
    protected $customerOrderModel;
    protected $customerOrderItemsModel;
    protected $userModel;
    function __construct() {
        $this->productModel = new ProductModel();
        $this->salesModel = new Salesmodel();
        $this->saleItemModel = new SaleItemModel();
        $this->purchaseItemModel = new PurchaseOrderItemModel();
        $this->customerOrderModel = new CustomerOrderModel();
        $this->customerOrderItemsModel = new CustomerOrderItemsModel();
        $this->userModel = new UsersregistrationsModel();
    }

    public function index() {
        $page = (!hasPermission('','sales') ? lang('Custom.permissionDenied') :'Sales');
        $route = (!hasPermission('','sales') ?'pages-error-404' :'admin/sales/index');
        $products = $this->productModel->where(['status'=>1,'current_stock >'=>0])->findAll();
        return view($route,compact('page','products'));
    }
//   FIFO
public function save()
{
    if (!hasPermission('', 'sales')) {
        return $this->response->setJSON([
            'success' => false,
            'message' => lang('Custom.permissionDenied')
        ]);
    }

    if (!$this->request->isAJAX()) {
        return $this->response->setJSON([
            'success' => false,
            'message' => lang('Custom.invalidRequest')
        ]);
    }

    // ---------- Validate main sale fields ----------
    $rules = [
        'sale_date' => 'required|valid_date[Y-m-d]',
    ];

    if (!$this->validate($rules)) {
        return $this->response->setJSON([
            'success' => false,
            'errors'  => $this->validator->getErrors()
        ]);
    }

    // ---------- Collect item inputs ----------
    $categories = $this->request->getPost('category');
    $quantities = $this->request->getPost('quantity');
    $sale_date  = $this->request->getPost('sale_date');

    // ---------- Basic validation ----------
    $errors = [];
    foreach ($categories as $i => $cat) {
        if (empty($cat)) {
            $errors["category.$i"] = "Category is required.";
        }
        if (empty($quantities[$i]) || $quantities[$i] <= 0) {
            $errors["quantity.$i"] = "Quantity is required.";
        }
    }

    if (!empty($errors)) {
        return $this->response->setJSON([
            'success'     => false,
            'item_errors' => $errors
        ]);
    }

    // ---------- Generate invoice number ----------
    $lastNumber = 1;
    $datePart   = date('ymd');

    $builder = $this->salesModel
        ->like('invoice_number', $datePart, 'after')
        ->orderBy('id', 'DESC')
        ->limit(1)
        ->get();

    if ($builder->getNumRows() > 0) {
        $lastInvoice = $builder->getRow()->invoice_number;
        $lastNumber  = (int) substr($lastInvoice, -3);
        $lastNumber++;
    }

    $invoice_no = 'INV' . $datePart . '-' . str_pad($lastNumber, 3, '0', STR_PAD_LEFT);

    // ---------- Prepare Sale Data ----------
    $customerName   = $this->request->getPost('customer_name') ?? 'SANA FRESH';
    $payment_status = $this->request->getPost('payment_status') ?? 'Paid';

    $total_amount = 0;
    $saleItems = [];
    $messages = [];

    // ---------- Loop through items ----------
    foreach ($categories as $i => $productId) {
        $productInfo = $this->productModel->find($productId);
        if (!$productInfo) continue;

        $saleQty = (float)$quantities[$i];
        $totalForItem = 0;

        // FIFO: Get oldest purchase batches
        $batches = $this->purchaseItemModel
            ->where('product_id', $productId)
            ->where('remaining_qty >', 0)
            ->orderBy('id', 'ASC')
            ->findAll();

        if (empty($batches)) {
            $messages[] = "No stock found for <b>{$productInfo['product_name']}</b>";
            continue;
        }

        // ---------- FIFO Consumption ----------
        foreach ($batches as $batch) {
            if ($saleQty <= 0) break;

            $available = $batch['remaining_qty'];
            $takeQty   = min($saleQty, $available);
            $rate      = $batch['price']; // or purchase_rate if you use that column

            // Update batch remaining
            $this->purchaseItemModel->update($batch['id'], [
                'remaining_qty' => $available - $takeQty
            ]);

            // Add to sale items
            $saleItems[] = [
                'sale_id'     => 0, // updated later
                'product_id'  => $productId,
                'quantity'    => $takeQty,
                'unit_price'  => $rate,
                'total'       => $takeQty * $rate,
            ];

            $totalForItem += $takeQty * $rate;
            $saleQty -= $takeQty;
        }

        // If still pending â†’ insufficient stock
        if ($saleQty > 0) {
            $messages[] = "The Item <b>{$productInfo['product_name']}</b> has low stock (Available: {$productInfo['current_stock']})";
        }

        // Update product current stock
        $this->productModel->update($productId, [
            'current_stock' => $productInfo['current_stock'] - $quantities[$i]
        ]);

        // Add to total sale value
        $total_amount += $totalForItem;
    }

    // ---------- Stop if stock issue ----------
    if (!empty($messages)) {
        return $this->response->setJSON([
            'success'  => false,
            'messages' => $messages
        ]);
    }

    // ---------- Insert Sale ----------
    $salesData = [
        'invoice_number' => $invoice_no,
        'customer_name'  => $customerName,
        'sale_date'      => $sale_date,
        'payment_status' => $payment_status,
        'total_amount'   => $total_amount,
        'note'           => $this->request->getPost('note'),
        'status'         => 2,
        'created_by'     => session('user_data')['id'],
    ];

    $saleId = $this->salesModel->insert($salesData, true);

    if ($saleId) {
        // Assign sale_id and insert sale items
        foreach ($saleItems as &$item) {
            $item['sale_id'] = $saleId;
        }

        $this->saleItemModel->insertBatch($saleItems);

        return $this->response->setJSON([
            'success' => true,
            'message' => 'Sale completed successfully (FIFO applied)',
            'total_amount' => number_format($total_amount, 2)
        ]);
    }

    return $this->response->setJSON([
        'success' => false,
        'message' => 'Oops! Something went wrong, please try again.'
    ]);
}



    function list() {

        if(!hasPermission('','sales')) {
            return $this->response->setJSON(['success' => false ,'message' => lang('Custom.permissionDenied')]);
        }
        if(!$this->request->isAJAX()) {
            return $this->response->setJSON(['success' => false,'message' => lang('Custom.invalidRequest')]);
        }
        $filter = $this->request->getPost('filter');
        $searchInput = $this->request->getPost('search');
        $startDate = $this->request->getPost('startDate');
        $endDate = $this->request->getPost('endDate');
        $orderId = decryptor($this->request->getPost('id'));
        $purchaseInvoice = $this->customerOrderModel->salesHistory($searchInput,$filter,$startDate,$endDate,$orderId);

        $purchaseHistory = [];
        
        foreach ($purchaseInvoice as &$purchase) {
            $purchaseOrderId = $purchase['orderId'];
            if(!isset($purchaseHistory[$purchaseOrderId])) {
                $purchaseHistory[$purchaseOrderId] = [
                    'orderId'   => encryptor($purchaseOrderId),
                    'inoicenumber'  => $purchase['order_number'],
                    'sale_date'     => $purchase['orderDate'],
                    'payment'       => $purchase['payment_status'],
                    'orderStatus'   => $purchase['status'],
                    'paymentMethod' => $purchase['payment_method'],
                    'note'          => '',
                    'customer'      => $purchase['customerName'],
                    'phone'         => $purchase['customerPhone'],
                    'email'         => $purchase['customerEmail'],
                    'totalAmount'  => $purchase['total_amount'],
                    'items'         => []
                ];
                if(!empty($purchase['product_title'])) {
                    $purchaseHistory[$purchaseOrderId]['items'][] = [
                        'product'   => $purchase['product_title'],
                        'sku'       => $purchase['sku'],
                        'price'     => $purchase['unit_price'],
                        'quantity'  => $purchase['quantity'],
                        'total'     => $purchase['total'],
                    ];
                }
            }else{
                if(!empty($purchase['product_title'])) {
                    $purchaseHistory[$purchaseOrderId]['items'][] = [
                        'product'   => $purchase['product_title'],
                        'sku'       => $purchase['sku'],
                        'price'     => $purchase['unit_price'],
                        'quantity'  => $purchase['quantity'],
                        'total'     => $purchase['total'],
                    ];
                }
            }
        }

        $result = array_values($purchaseHistory);
        return $this->response->setJSON(['success' => true,'products' => $result]);
    }

    function edit($id=false) {

        $saleId = decryptor($id);
    
        $page = (!hasPermission('','edit_sale') ? lang('Custom.permissionDenied') : 'Edit Sale');
        $route = (hasPermission('','edit_sale') ? 'admin/sales/create' : 'pages-error-404');
        $products = $this->productModel->where('status',1)->findAll();

        $purchaseInvoice = $this->salesModel->salesHistory('','','','',$saleId);
        $purchaseHistory = [];
        //echo  $this->salesModel->getLastQuery();
        foreach ($purchaseInvoice as &$purchase) {
            $purchaseOrderId = $purchase['id'];
            if(!isset($purchaseHistory[$purchaseOrderId])) {
                $purchaseHistory[$purchaseOrderId] = [
                    'orderId'   => encryptor($purchaseOrderId),
                    'inoicenumber'  => $purchase['invoice_number'],
                    'customer_name' => $purchase['customer_name'],
                    'sale_date'     => $purchase['sale_date'],
                    'payment'       => $purchase['payment_status'],
                    'note'          => $purchase['note'],
                    'customer'      => $purchase['customer_name'],
                    'totalAmount'  => $purchase['total_amount'],
                    'items'         => []
                ];
                if(!empty($purchase['product_name'])) {
                    $purchaseHistory[$purchaseOrderId]['items'][] = [
                        'saleId'    => $purchase['saleId'],
                        'product'   => $purchase['product_name'],
                        'productId'   => $purchase['productId'],
                        'sku'       => $purchase['sku'],
                        'price'     => $purchase['unit_price'],
                        'quantity'  => $purchase['quantity'],
                        'total'     => $purchase['total'],
                    ];
                }
            }else{
                if(!empty($purchase['product_name'])) {
                    $purchaseHistory[$purchaseOrderId]['items'][] = [
                        'saleId'    => $purchase['saleId'],
                        'product'   => $purchase['product_name'],
                        'productId'   => $purchase['productId'],
                        'sku'       => $purchase['sku'],
                        'price'     => $purchase['unit_price'],
                        'quantity'  => $purchase['quantity'],
                        'total'     => $purchase['total'],
                    ];
                }
            }
        }
        $result = array_values($purchaseHistory);
        return view($route,compact('page','products','result'));
    }

    function saleUpdate() {
         if (!hasPermission('', 'sales')) {
            return $this->response->setJSON([
                'success' => false,
                'message' => lang('Custom.permissionDenied')
            ]);
        }

        if (!$this->request->isAJAX()) {
            return $this->response->setJSON([
                'success' => false,
                'message' => lang('Custom.invalidRequest')
            ]);
        }

        // ---------- Validate main sale fields ----------
        $rules = [
            'customer_name'  => 'required|min_length[2]',
            'sale_date'      => 'required|valid_date[Y-m-d]',
            'payment_status' => 'required',
        ];

        if (!$this->validate($rules)) {
            return $this->response->setJSON([
                'success' => false,
                'errors'  => $this->validator->getErrors()
            ]);
        }

        // ---------- Collect item inputs ----------
        $categories = $this->request->getPost('category');
        $quantities = $this->request->getPost('quantity');
        $prices     = $this->request->getPost('price');
        $itemsId    = $this->request->getPost('itemsId');
        $mastersaleId = decryptor( $this->request->getPost('mastersaleId'));  

        $errors = [];
        foreach ($categories as $i => $cat) {
            if (empty($cat)) {
                $errors["category.$i"] = "Category is required.";
            }
            if (empty($quantities[$i])) {
                $errors["quantity.$i"] = "Quantity is required.";
            }
            if (empty($prices[$i])) {
                $errors["price.$i"] = "Price is required.";
            }
        }

        if (!empty($errors)) {
            return $this->response->setJSON([
                'success'     => false,
                'item_errors' => $errors
            ]);
        }
      $totalAmount = 0.0;

        foreach($categories as $index => $productId) {

            $qty   = (float) $quantities[$index];
            $price = (float) $prices[$index];
            $lineTotal = $qty * $price;
            $totalAmount += $lineTotal;

            $saleItmId = $itemsId[$index] ?? null; // if not exists, it's a new item

            if ($saleItmId) {
                
                $oldItem = $this->saleItemModel->find($saleItmId);
                $oldQty  = (float)$oldItem['quantity'];

               if ($qty != $oldQty || $productId != $oldItem['product_id']) {
                    $diff = $qty - $oldQty; // positive = need more stock, negative = return stock

                    if ($diff > 0) {
                        // Need extra stock
                        $currentStock = $this->productModel->find($productId)['current_stock'];
                         $productInfo = $this->productModel->find($productId);
                        if ($currentStock < $diff) {
                            return $this->response->setJSON([
                                'success' => false,
                                'message' => "Not enough stock for product ".$productInfo['product_name']
                            ]);
                        }
                        $this->productModel->update($productId, [
                            'current_stock' => $currentStock - $diff
                        ]);
                    } else {
                        // Return stock
                        $this->productModel->where('id', $productId)
                                        ->set('current_stock', "current_stock + " . abs($diff), false)
                                        ->update();
                    }

                    // Update sale item
                    $this->saleItemModel->update($saleItmId, [
                        'quantity'   => $qty,
                        'product_id' => $productId,
                        'unit_price' => $price,
                        'total'      => $lineTotal,
                    ]);
                }

            } else {
                // New Item Added
                $currentStock = $this->productModel->find($productId)['current_stock'];
                if ($currentStock < $qty) {
                    return $this->response->setJSON([
                        'success' => false,
                        'message' => "Not enough stock for product ID $productId"
                    ]);
                }

                // Deduct stock
                $this->productModel->update($productId, [
                    'current_stock' => $currentStock - $qty
                ]);

                // Insert new sale item
                $this->saleItemModel->insert([
                    'sale_id'    => $mastersaleId,
                    'product_id' => $productId,
                    'quantity'   => $qty,
                    'unit_price' => $price,
                    'total'      => $lineTotal,
                ]);
            }
        }

        // Update master sale
        $purchaseHistory = [
            'customer_name' => $this->request->getPost('customer_name'),
            'sale_date'     => $this->request->getPost('sale_date'),
            'payment_status'=> $this->request->getPost('payment_status'),
            'note'          => $this->request->getPost('note'),
            'total_amount'  => $totalAmount,
        ];
        $this->salesModel->update($mastersaleId, $purchaseHistory);

        return $this->response->setJSON([
            'success' => true,
            'message' => 'Sale updated and stock adjusted successfully'
        ]);
    }


    //paymentUpdate 
    public function paymentUpdate() {
        if (!$this->request->isAJAX()) {
            return $this->response->setJSON([
                'success' => false,
                'message' => lang('Custom.invalidRequest')
            ]);
        }

        $orderId = decryptor($this->request->getPost('orderId'));
        $orderStatus = $this->request->getPost('orderStatus');
        $paymentStatus = $this->request->getPost('paymentStatus');

        $this->customerOrderModel->update($orderId, [
            'payment_status' => ($orderStatus == 'pending') ? 1 : (($paymentStatus == 'paid') ? 2 : (($paymentStatus == 'failed') ? 3 : 4)),
        ]);
        $this->mailnotification($orderId,['type' => 'payment','status' => $paymentStatus]);

        return $this->response->setJSON([
            'success' => true,
            'message' => 'Order status updated to '.$paymentStatus.' successfully'
        ]);
    }
    
    //orderUpdate 
    public function orderUpdate() {
        if (!$this->request->isAJAX()) {
            return $this->response->setJSON([
                'success' => false,
                'message' => lang('Custom.invalidRequest')
            ]);
        }

        $orderId = decryptor($this->request->getPost('orderId'));
        $orderStatus = $this->request->getPost('orderStatus');
        $paymentStatus = $this->request->getPost('paymentStatus');

        $this->customerOrderModel->update($orderId, [
            'status' => ($orderStatus == 'pending') ? 1 : (($orderStatus == 'confirmed') ? 2 : (($orderStatus == 'cancelled') ? 3 : 4)),
            //'payment_status' => $paymentStatus
        ]);
        $this->mailnotification($orderId,['type' => 'order','status' => $orderStatus]);

        return $this->response->setJSON([
            'success' => true,
            'message' => 'Order status updated to '.$orderStatus.' successfully'
        ]);
    }

    private function mailnotification($order_id,$mailType) {
        if(getappdata('order_status_mail_notification') == 'off') {
            return false;
        }
        $emailService = \Config\Services::email();
        $order = $this->customerOrderModel->find($order_id);
        $order_items = $this->customerOrderItemsModel->where('customer_orders_items.customer_order_id', $order_id)->
        join('product_management', 'product_management.id = customer_orders_items.product_id')
        ->get()
        ->getResultArray();
        $user = $this->userModel->where('id', $order['user_id'])->get()->getRow();
        $subject = '';
        if($mailType['type'] == 'payment') {
           $subject = 'Your Payment Status Has Been Updated to '.ucfirst($mailType['status']);
           $messages = 'Your Payment Status Has Been Updated to '.ucfirst($mailType['status']);
        }else{
            $subject = "Update: Your Order is Now " . ucfirst($mailType['status']);
            $messages = 'Your Order is Now ' . ucfirst($mailType['status']);
        }
        $emailService->setTo($user->email);
        $emailService->setSubject($subject);
        $emailService->setMessage(view('frontend/email/notificationMail', compact('order', 'user','messages','subject')));
        $emailService->send();
    }

    public function downloadInvoice($id) {
        $orderId = decryptor($id);
        $purchaseInvoice = $this->customerOrderModel->salesHistory(null,null,null,null,$orderId);

        $purchaseHistory = [];
        $invoiceNo = '';
        foreach ($purchaseInvoice as &$purchase) {
            $purchaseOrderId = $purchase['orderId'];
            if(!isset($purchaseHistory[$purchaseOrderId])) {
                $invoiceNo = $purchase['order_number'];
                $purchaseHistory[$purchaseOrderId] = [
                    'orderId'   => encryptor($purchaseOrderId),
                    'inoicenumber'  => $purchase['order_number'],
                    'orderDate'     => $purchase['orderDate'],
                    'payment'       => $purchase['payment_status'],
                    'orderStatus'   => $purchase['status'],
                    'paymentMethod' => $purchase['payment_method'],
                    'note'          => '',
                    'tax'           => $purchase['tax'],
                    'customer'      => $purchase['customerName'],
                    'phone'         => $purchase['customerPhone'],
                    'email'         => $purchase['customerEmail'],
                    'totalAmount'  => $purchase['total_amount'],
                    'shippingAddress' => json_encode([
                    'name' => $purchase['shipping_full_name'],
                    'phone' => $purchase['shipping_phone'],
                    'address' => $purchase['shipping_address_line1'].','.$purchase['shipping_city'].', '.$purchase['shipping_state'].', '.$purchase['shipping_postal_code'].', '.$purchase['shipping_country'],
                    ]),
                    'items'         => []
                ];
                if(!empty($purchase['product_title'])) {
                    $purchaseHistory[$purchaseOrderId]['items'][] = [
                        'product'   => $purchase['product_title'],
                        'sku'       => $purchase['sku'],
                        'price'     => $purchase['unit_price'],
                        'quantity'  => $purchase['quantity'],
                        'total'     => $purchase['total'],
                    ];
                }
            }else{
                if(!empty($purchase['product_title'])) {
                    $purchaseHistory[$purchaseOrderId]['items'][] = [
                        'product'   => $purchase['product_title'],
                        'sku'       => $purchase['sku'],
                        'price'     => $purchase['unit_price'],
                        'quantity'  => $purchase['quantity'],
                        'total'     => $purchase['total'],
                    ];
                }
            }
        }

        $result = array_values($purchaseHistory);

         $mpdf = new Mpdf([
            'mode' => 'utf-8',
            'format' => 'A4',
            'orientation' => 'P',
            'default_font_size' => 10,
            'default_font' => 'dejavusans',
        ]);

        $html = view('admin/sales/invoice', compact('result'));
        
         $mpdf->WriteHTML($html);

        if (ob_get_length()) {
            ob_end_clean();
        }

        $invType = ( getappdata('invoice_type') == 'on') ? 'D' : 'I';
        $mpdf->Output("invoice_$invoiceNo.pdf", $invType);
        exit;
    }
}